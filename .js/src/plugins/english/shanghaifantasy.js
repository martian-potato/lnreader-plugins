var e=this&&this.__awaiter||function(e,a,l,t){return new(l||(l=Promise))((function(r,i){function n(e){try{u(t.next(e))}catch(e){i(e)}}function o(e){try{u(t.throw(e))}catch(e){i(e)}}function u(e){var a;e.done?r(e.value):(a=e.value,a instanceof l?a:new l((function(e){e(a)}))).then(n,o)}u((t=t.apply(e,a||[])).next())}))},a=this&&this.__generator||function(e,a){var l,t,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},n=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return n.next=o(0),n.throw=o(1),n.return=o(2),"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function o(o){return function(u){return function(o){if(l)throw new TypeError("Generator is already executing.");for(;n&&(n=0,o[0]&&(i=0)),i;)try{if(l=1,t&&(r=2&o[0]?t.return:o[0]?t.throw||((r=t.return)&&r.call(t),0):t.next)&&!(r=r.call(t,o[1])).done)return r;switch(t=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,t=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(r=i.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){i.label=o[1];break}if(6===o[0]&&i.label<r[1]){i.label=r[1],r=o;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(o);break}r[2]&&i.ops.pop(),i.trys.pop();continue}o=a.call(e,i)}catch(e){o=[6,e],t=0}finally{l=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,u])}}};Object.defineProperty(exports,"__esModule",{value:!0});var l=require("@libs/fetch"),t=require("cheerio"),r=require("@libs/filterInputs"),i=require("@libs/storage"),n=require("@libs/defaultCover"),o=function(){function o(){var e=this;this.id="shanghaifantasy",this.name="Shanghai Fantasy",this.icon="src/en/shanghaifantasy/icon.png",this.site="https://shanghaifantasy.com",this.version="1.0.10",this.imageRequestInit=void 0,this.hideLocked=i.storage.get("hideLocked"),this.pluginSettings={hideLocked:{value:"",label:"Hide locked chapters",type:"Switch"}},this.resolveUrl=function(a,l){return e.site+"/series/"+a},this.filters={status:{type:r.FilterTypes.Picker,label:"Status",value:"all",options:[{label:"All",value:"all"},{label:"Ongoing",value:"Ongoing"},{label:"Completed",value:"Completed"},{label:"Dropped",value:"Dropped"},{label:"Hiatus",value:"Hiatus"}]},sort:{type:r.FilterTypes.Picker,label:"Sort",value:"orderby=date&order=desc",options:[{label:"Recent",value:"orderby=date&order=desc"},{label:"Older",value:"orderby=date&order=asc"},{label:"Title",value:"orderby=title&order=asc"},{label:"Title (Reversed)",value:"orderby=title&order=desc"}]},genres:{type:r.FilterTypes.CheckboxGroup,label:"Genres",value:[],options:[{label:"1960s",value:"1960s"},{label:"1970s",value:"1970s"},{label:"1980s",value:"1980s"},{label:"1990s",value:"1990s"},{label:"80s Setting",value:"80s Setting"},{label:"Abandoned",value:"Abandoned"},{label:"ABO",value:"ABO"},{label:"Action",value:"Action"},{label:"Adopted Children",value:"Adopted Children"},{label:"Adorable Baby",value:"Adorable Baby"},{label:"Adult",value:"Adult"},{label:"Adventure",value:"Adventure"},{label:"Affectionate Relationship",value:"Affectionate Relationship"},{label:"Age Gap",value:"Age Gap"},{label:"Alternate Universe",value:"Alternate Universe"},{label:"Alternate World",value:"Alternate World"},{label:"Amnesia",value:"Amnesia"},{label:"Ancient China",value:"Ancient China"},{label:"Ancient Farming",value:"Ancient Farming"},{label:"Ancient Romance",value:"Ancient Romance"},{label:"ancient style",value:"ancient style"},{label:"Ancient Times",value:"Ancient Times"},{label:"Angst",value:"Angst"},{label:"Apocalypse",value:"Apocalypse"},{label:"Arranged Marriage",value:"Arranged Marriage"},{label:"Beastmen",value:"Beastmen"},{label:"Beautiful Female Lead",value:"Beautiful Female Lead"},{label:"Beautiful protagonist",value:"Beautiful protagonist"},{label:"BG",value:"BG"},{label:"Bickering Couple",value:"Bickering Couple"},{label:"BL",value:"BL"},{label:"Book Transmigration",value:"Book Transmigration"},{label:"Boys Love",value:"Boys Love"},{label:"Business",value:"Business"},{label:"Business management",value:"Business management"},{label:"Bussiness",value:"Bussiness"},{label:"celebrity",value:"celebrity"},{label:"CEO",value:"CEO"},{label:"Character Growth",value:"Character Growth"},{label:"Charismatic MC",value:"Charismatic MC"},{label:"Charming Protagonist",value:"Charming Protagonist"},{label:"Childcare",value:"Childcare"},{label:"Childhood Love",value:"Childhood Love"},{label:"Comedy",value:"Comedy"},{label:"Contemporary",value:"Contemporary"},{label:"Cooking",value:"Cooking"},{label:"Countryside",value:"Countryside"},{label:"Crime",value:"Crime"},{label:"Crime Investigation",value:"Crime Investigation"},{label:"Crossing",value:"Crossing"},{label:"Cultivation",value:"Cultivation"},{label:"cute baby",value:"cute baby"},{label:"Cute Child",value:"Cute Child"},{label:"Cute Children",value:"Cute Children"},{label:"Cute Protagonist",value:"Cute Protagonist"},{label:"Dimensional Space",value:"Dimensional Space"},{label:"Doting Husband",value:"Doting Husband"},{label:"Doting Love Interest",value:"Doting Love Interest"},{label:"Double Purity",value:"Double Purity"},{label:"Drama",value:"Drama"},{label:"dual male lead",value:"dual male lead"},{label:"Ecchi",value:"Ecchi"},{label:"Educated Youth",value:"Educated Youth"},{label:"Entertainment",value:"Entertainment"},{label:"Entertainment Industry",value:"Entertainment Industry"},{label:"Era",value:"Era"},{label:"Era Farming",value:"Era Farming"},{label:"Era novel",value:"Era novel"},{label:"Era Romance",value:"Era Romance"},{label:"Face-Slapping",value:"Face-Slapping"},{label:"Familial Love",value:"Familial Love"},{label:"Family",value:"Family"},{label:"Family Bonds",value:"Family Bonds"},{label:"Family conflict",value:"Family conflict"},{label:"Family Doting",value:"Family Doting"},{label:"Family Drama",value:"Family Drama"},{label:"Family Life",value:"Family Life"},{label:"Fanfiction",value:"Fanfiction"},{label:"Fantasy",value:"Fantasy"},{label:"Fantasy Romance",value:"Fantasy Romance"},{label:"Farming",value:"Farming"},{label:"Farming life",value:"Farming life"},{label:"Fate and Destiny",value:"Fate and Destiny"},{label:"Female Lead",value:"Female Lead"},{label:"Female Protagonist",value:"Female Protagonist"},{label:"Flash Marriage",value:"Flash Marriage"},{label:"Free Love",value:"Free Love"},{label:"FREE NOVEL‼️",value:"FREE NOVEL‼️"},{label:"Futuristic",value:"Futuristic"},{label:"Game",value:"Game"},{label:"Game World",value:"Game World"},{label:"Gay",value:"Gay"},{label:"Gay Romance",value:"Gay Romance"},{label:"Gender Bender",value:"Gender Bender"},{label:"Getting Rich",value:"Getting Rich"},{label:"Ghost",value:"Ghost"},{label:"Gourmet Food",value:"Gourmet Food"},{label:"handsome male lead",value:"handsome male lead"},{label:"Happy Ending",value:"Happy Ending"},{label:"Harem",value:"Harem"},{label:"HE (Happy Ending)",value:"HE (Happy Ending)"},{label:"Heartwarming",value:"Heartwarming"},{label:"Historical",value:"Historical"},{label:"Historical BL",value:"Historical BL"},{label:"Historical Fiction",value:"Historical Fiction"},{label:"Historical Romance",value:"Historical Romance"},{label:"Horror",value:"Horror"},{label:"Humor",value:"Humor"},{label:"Interstellar",value:"Interstellar"},{label:"Isekai",value:"Isekai"},{label:"Josei",value:"Josei"},{label:"LGBT+",value:"LGBT+"},{label:"Light-hearted",value:"Light-hearted"},{label:"Lighthearted",value:"Lighthearted"},{label:"Livestream",value:"Livestream"},{label:"livestreaming",value:"livestreaming"},{label:"love",value:"love"},{label:"Love After Marriage",value:"Love After Marriage"},{label:"love at first sight",value:"love at first sight"},{label:"Love Confession",value:"Love Confession"},{label:"loyal male lead",value:"loyal male lead"},{label:"Lucky Protagonist",value:"Lucky Protagonist"},{label:"Magical Realism",value:"Magical Realism"},{label:"magical space",value:"magical space"},{label:"Male Protagonist",value:"Male Protagonist"},{label:"Marriage",value:"Marriage"},{label:"Marriage Before Love",value:"Marriage Before Love"},{label:"Martial Arts",value:"Martial Arts"},{label:"Mature",value:"Mature"},{label:"Mecha",value:"Mecha"},{label:"medical skills",value:"medical skills"},{label:"Metaphysics",value:"Metaphysics"},{label:"Military",value:"Military"},{label:"Military Husband",value:"Military Husband"},{label:"Military Marriage",value:"Military Marriage"},{label:"Military Romance",value:"Military Romance"},{label:"Military Wife",value:"Military Wife"},{label:"mind reading",value:"mind reading"},{label:"Modern",value:"Modern"},{label:"Modern Day",value:"Modern Day"},{label:"Modern Romance",value:"Modern Romance"},{label:"Modern/Contemporary",value:"Modern/Contemporary"},{label:"Mpreg",value:"Mpreg"},{label:"Mutated beast",value:"Mutated beast"},{label:"Mystery",value:"Mystery"},{label:"Mythical Beasts",value:"Mythical Beasts"},{label:"Obsessive love",value:"Obsessive love"},{label:"Older Love Interests",value:"Older Love Interests"},{label:"omegaverse",value:"omegaverse"},{label:"palace fighting",value:"palace fighting"},{label:"Pampering Wife",value:"Pampering Wife"},{label:"Period Novel",value:"Period Novel"},{label:"Poor Protagonist",value:"Poor Protagonist"},{label:"Poor to rich",value:"Poor to rich"},{label:"Power Couple",value:"Power Couple"},{label:"Power Fantasy",value:"Power Fantasy"},{label:"Powers",value:"Powers"},{label:"pregnancy",value:"pregnancy"},{label:"Psychological",value:"Psychological"},{label:"Pursuit of love",value:"Pursuit of love"},{label:"Quick transmigration",value:"Quick transmigration"},{label:"raising a baby",value:"raising a baby"},{label:"Rebirth",value:"Rebirth"},{label:"Reborn",value:"Reborn"},{label:"Redemption",value:"Redemption"},{label:"reincarnation",value:"reincarnation"},{label:"Revenge",value:"Revenge"},{label:"Rich CEO",value:"Rich CEO"},{label:"Rich Family",value:"Rich Family"},{label:"Romance",value:"Romance"},{label:"Romantic Comedy",value:"Romantic Comedy"},{label:"Royal Family",value:"Royal Family"},{label:"Royalty",value:"Royalty"},{label:"Rural",value:"Rural"},{label:"Rural life",value:"Rural life"},{label:"SameSexMarriage",value:"SameSexMarriage"},{label:"Schemes and Conspiracies",value:"Schemes and Conspiracies"},{label:"Scheming Female Lead",value:"Scheming Female Lead"},{label:"School Life",value:"School Life"},{label:"Sci-fi",value:"Sci-fi"},{label:"Second Chance",value:"Second Chance"},{label:"Secret Crush",value:"Secret Crush"},{label:"Secret Identity",value:"Secret Identity"},{label:"seinen",value:"seinen"},{label:"Short Story",value:"Short Story"},{label:"Shoujo",value:"Shoujo"},{label:"Shoujo Ai",value:"Shoujo Ai"},{label:"Shounen",value:"Shounen"},{label:"Shounen Ai",value:"Shounen Ai"},{label:"Showbiz",value:"Showbiz"},{label:"Slice of Life",value:"Slice of Life"},{label:"Slow Burn",value:"Slow Burn"},{label:"slow romance",value:"slow romance"},{label:"Slow-burn Romance",value:"Slow-burn Romance"},{label:"Smut",value:"Smut"},{label:"Space",value:"Space"},{label:"Space Ability",value:"Space Ability"},{label:"special abilities",value:"special abilities"},{label:"Sports",value:"Sports"},{label:"Stand-in Lover",value:"Stand-in Lover"},{label:"Strong Female Lead",value:"Strong Female Lead"},{label:"Strong Love Interest",value:"Strong Love Interest"},{label:"Supernatural",value:"Supernatural"},{label:"supporting characters",value:"supporting characters"},{label:"Supporting Female Character",value:"Supporting Female Character"},{label:"Survival",value:"Survival"},{label:"Suspense",value:"Suspense"},{label:"Sweet",value:"Sweet"},{label:"Sweet Doting",value:"Sweet Doting"},{label:"Sweet Love",value:"Sweet Love"},{label:"Sweet Marriage",value:"Sweet Marriage"},{label:"Sweet Pampering",value:"Sweet Pampering"},{label:"sweet pet",value:"sweet pet"},{label:"Sweet Revenge",value:"Sweet Revenge"},{label:"Sweet Romance",value:"Sweet Romance"},{label:"Sweet Story",value:"Sweet Story"},{label:"SweetNovel",value:"SweetNovel"},{label:"system",value:"system"},{label:"Thriller",value:"Thriller"},{label:"Time Travel",value:"Time Travel"},{label:"Tragedy",value:"Tragedy"},{label:"Transformation",value:"Transformation"},{label:"Transmigration",value:"Transmigration"},{label:"transmigration into a novel",value:"transmigration into a novel"},{label:"Transmigration into Books",value:"Transmigration into Books"},{label:"Traveling through space",value:"Traveling through space"},{label:"Traveling through time",value:"Traveling through time"},{label:"Ugly",value:"Ugly"},{label:"Unlimited Flow",value:"Unlimited Flow"},{label:"Urban",value:"Urban"},{label:"urban life",value:"urban life"},{label:"Village Life",value:"Village Life"},{label:"Villain",value:"Villain"},{label:"Weak to Strong",value:"Weak to Strong"},{label:"wealthy characters",value:"wealthy characters"},{label:"Wealthy Family",value:"Wealthy Family"},{label:"Wuxia",value:"Wuxia"},{label:"Xianxia",value:"Xianxia"},{label:"Xuanhuan",value:"Xuanhuan"},{label:"yandere",value:"yandere"},{label:"Yaoi",value:"Yaoi"},{label:"Younger Love Interest",value:"Younger Love Interest"},{label:"Yuri",value:"Yuri"},{label:"Zombie",value:"Zombie"},{label:"🔓 Completely Unlocked 🔓",value:"🔓 Completely Unlocked 🔓"}]}}}return o.prototype.popularNovels=function(t,r){return e(this,arguments,void 0,(function(e,t){var r,i,n=this,o=(t.showLatestNovels,t.filters);return a(this,(function(a){switch(a.label){case 0:return r=o.genres.value.join("*"),i="all"!==o.status.value?o.status.value:"",[4,(0,l.fetchApi)("".concat(this.site,"/wp-json/fiction/v1/novels/?novelstatus=").concat(i,"&page=").concat(e,"&term=").concat(r,"&").concat(o.sort.value)).then((function(e){return e.json()}))];case 1:return[2,a.sent().map((function(e){return n.parseNovelFromApi(e)}))]}}))}))},o.prototype.parseNovel=function(r){return e(this,void 0,void 0,(function(){var e,i,o,s,v;return a(this,(function(a){switch(a.label){case 0:return[4,(0,l.fetchApi)("".concat(this.site,"/novel/").concat(r,"/"),{headers:{"User-Agent":""}}).then((function(e){return e.text()}))];case 1:return e=a.sent(),i=(0,t.load)(e),(o={path:r,name:u(i("div.ml-5.p-1.flex.flex-col > p.mb-3.text-lg").text()),id:i("#chapterList").data("cat"),summary:i('[x-show*="Synopsis"] p').map((function(e,a){return(0,t.load)(a).text()})).get().join("\n\n").trim()}).author=i("header + div:first > div > div > p:eq(2)").contents()[1].data,s=i("header + div:first > img").attr("src"),o.cover=s||n.defaultCover,o.genres=i('header + div:first > div span:has(> a[href*="genre="])').map((function(e,a){return(0,t.load)(a).text().trim()})).toArray().join(","),o.status=i("header + div:first > div > a > p").first().text().trim(),[4,this.fetchChapters(o.id,1)];case 2:return v=a.sent(),this.hideLocked&&(v=v.filter((function(e){return!e.locked}))),console.log(v),o.chapters=v.map((function(e){return{name:(e.locked?"🔒 ":"")+"Chapter "+u(e.title.replace(/^.+ Chapter /i,""),!1),path:e.permalink.split("/").at(-2),chapterNumber:parseFloat(e.title.replace(/^.+ ([0-9]+.?[0-9]?)$/i,"$1"))}})).sort((function(e,a){return e.chapterNumber-a.chapterNumber})),[2,o]}}))}))},o.prototype.parseChapter=function(r){return e(this,void 0,void 0,(function(){var e,i;return a(this,(function(a){switch(a.label){case 0:return[4,(0,l.fetchApi)(this.site+"/"+r,{headers:{"User-Agent":""}}).then((function(e){return e.text()}))];case 1:return e=a.sent(),(i=(0,t.load)(e))("div.ai-viewports").remove(),[2,i("div.contenta").html()||""]}}))}))},o.prototype.searchNovels=function(t,r){return e(this,void 0,void 0,(function(){var e=this;return a(this,(function(a){switch(a.label){case 0:return[4,(0,l.fetchApi)("".concat(this.site,"/wp-json/fiction/v1/novels/?novelstatus=&term=&page=").concat(r,"&orderby=&order=&query=").concat(encodeURIComponent(t))).then((function(e){return e.json()})).then((function(a){return a.map((function(a){return e.parseNovelFromApi(a)}))}))];case 1:return[2,a.sent()]}}))}))},o.prototype.parseNovelFromApi=function(e){return{name:u(e.title),path:e.permalink.split("/").at(-2),cover:e.novelImage,summary:e.novelIntro,status:e.novelStat,genres:e.novelGenres.join(",")}},o.prototype.fetchChapters=function(t,r){return e(this,void 0,void 0,(function(){var e,i,n,o,u,s,v;return a(this,(function(a){switch(a.label){case 0:return[4,(0,l.fetchApi)("".concat(this.site,"/wp-json/fiction/v1/chapters/?category=").concat(t,"&page=").concat(r,"&order=asc"))];case 1:return e=a.sent(),i=parseInt(e.headers.get("x-wp-totalpages"),10),[4,e.json()];case 2:return n=a.sent(),r!=i?[3,3]:(o=n,[3,5]);case 3:return s=(u=Array.prototype).concat,v=[n],[4,this.fetchChapters(t,r+1)];case 4:o=s.apply(u,v.concat([a.sent()])),a.label=5;case 5:return[2,o]}}))}))},o}();function u(e,a){return void 0===a&&(a=!0),e=e.replace(/&#(\d+);|&#x([0-9a-fA-F]+);|&[a-zA-Z0-9]+;/g,(function(e,a,l){return void 0!==a?String.fromCharCode(parseInt(a,10)):void 0!==l?String.fromCharCode(parseInt(l,16)):e})),a&&(e=e.replace(/^[“”‘.]|[“”‘.]{0,2}$/g,"")),e}exports.default=new o;